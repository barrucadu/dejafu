#!/usr/bin/env bash

export PATH=$HOME/.local/bin:$PATH

stack="stack --no-terminal"

mkdir -p ~/.local/bin
curl -L https://www.stackage.org/stack/linux-x86_64 | \
  tar xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack'

$stack setup

# do not echo hackage password!
set +x

# sometimes uploading the package will "fail" in that an error is reported,
# but it actually worked.  this commonly seems to happen with timeouts.  in
# these cases, retrying the deploy job will fail, because the package has
# actually been uploaded.  it's not a great solution, but ignore failures here
# and just manually check that the deploy worked...
set +e

for pkg in concurrency dejafu hunit-dejafu tasty-dejafu; do
  echo "$stack upload $pkg"
  echo -e "barrucadu\n${HACKAGE_PASSWORD}\nn" | $stack upload $pkg
done

true
